import{d as F,H as q,w as $,q as _,g as s,e as f,f as n,c as w,p as V,$ as H,a0 as M,F as I,a1 as U,r as g,u as J,j as K,o as Q,k as G,b as d,h as W,m as x,t as X,B as R,_ as Y}from"./index-Cgi9ALMs.js";import{I as Z}from"./ImageUpload-yV3IXHLl.js";const ee=F({__name:"ContentForm",props:{modelValue:{},config:{},existingImages:{}},emits:["update:modelValue","remove-remote"],setup(B,{emit:C}){const v=B,p=C,u=q({...v.modelValue});$(()=>u,a=>{p("update:modelValue",a),console.log("[DEBUG][ContentForm] internalValue updated",a)},{deep:!0});function h(a){switch(a){case"input":return"el-input";case"textarea":return"el-input";case"number":return"el-input-number";case"switch":return"el-switch";case"image":return Z;default:return"el-input"}}function r(a){if(a.type==="textarea")return{type:"textarea",placeholder:a.label};if(a.type==="image"){const i=(v.existingImages??[]).map(m=>m.image);return{multiple:a.multiple??!1,existingImages:i,"onRemove-remote":m=>{const y=(v.existingImages??[]).find(l=>l.image===m);y?.id&&p("remove-remote",y.id)}}}return a.type==="number"?{min:0,placeholder:a.label}:{placeholder:a.label}}function b(a){a.type==="switch"&&(u[a.prop]=!!u[a.prop],console.log(`[DEBUG][ContentForm] switch ${a.prop} changed to`,u[a.prop]))}return(a,i)=>{const m=f("el-form-item"),y=f("el-form");return s(),_(y,{"label-position":"top"},{default:n(()=>[(s(!0),w(I,null,V(B.config?.formFields||[],l=>(s(),_(m,{key:l.prop,label:l.label},{default:n(()=>[(s(),_(H(h(l.type)),M({modelValue:u[l.prop],"onUpdate:modelValue":k=>u[l.prop]=k},{ref_for:!0},r(l),{onChange:k=>b(l)}),null,16,["modelValue","onUpdate:modelValue","onChange"]))]),_:2},1032,["label"]))),128))]),_:1})}}}),te={banners:{title:"首页轮播",api:U.banners,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"轮播图片",type:"image",multiple:!0},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]},features:{title:"首页特色",api:U.features,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"图标",type:"image",multiple:!1},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]},stories:{title:"品牌故事",api:U.stories,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"图片",type:"image",multiple:!0},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]}},ae={class:"card-header"},le={class:"table-wrapper",style:{position:"relative"}},oe=["src"],ne=F({__name:"ContentPage",setup(B){const C=J(),v=g(C.params.key),p=K(()=>{const t=te[v.value];if(!t)throw new Error(`Invalid content key: ${v.value}`);return t}),u=g([]),h=g(!0),r=g(!1),b=g(null),a=g({}),i=g([]),m=g(0);function y(t){return Array.isArray(t.images)?t.images.map(e=>({id:e.id,image:e.image})):t.icon?Array.isArray(t.icon)?t.icon.map(e=>({id:e.id,image:e.image||e})):[{image:t.icon}]:[]}async function l(){h.value=!1;try{const t=await p.value.api.list();u.value=t.data||[],console.log("[DEBUG] fetchList",u.value)}finally{h.value=!0}}function k(){console.log("[DEBUG] openCreate called"),b.value=null,a.value={},i.value=[],m.value++,r.value=!0,R(()=>console.log("[DEBUG] openCreate nextTick, visible=",r.value))}function A(t){console.log("[DEBUG] openEdit called, row=",t),b.value=t.id,a.value={...t},console.log("[DEBUG] openEdit called, row=",t),console.log("[DEBUG] existingImages before mapping=",t.images||t.icon),i.value=y(t).map(e=>({id:e.id,image:e.image})),m.value++,console.log("[DEBUG] openEdit existingImages=",i.value),r.value=!0,R(()=>console.log("[DEBUG] openEdit nextTick, visible=",r.value))}async function N(t){console.log("[DEBUG] deleteRow called, row=",t);try{await p.value.api.delete(t.id),await l()}catch(e){console.error("[ERROR] deleteRow failed",e)}}function P(t){console.log("[DEBUG] removeRemoteImage called, id=",t),console.log("[DEBUG] existingImages before removal=",i.value),i.value=i.value.filter(e=>e.id!==t),console.log("[DEBUG] existingImages after removal=",i.value)}async function T(){console.log("[DEBUG] submit called, form=",a.value,"existingImages=",i.value);const t=new FormData;Object.entries(a.value).forEach(([e,c])=>{e!=="images"&&t.append(e,c)}),i.value.forEach(e=>t.append("existing_images",String(e.id))),console.log("[DEBUG] FormData entries:");for(const e of t.entries())console.log(e[0],e[1]);a.value.images&&(Array.isArray(a.value.images)?a.value.images:[a.value.images]).forEach(c=>t.append("images",c));try{if(b.value)await p.value.api.update(b.value,t);else{const e=await p.value.api.create(t);b.value=e.data.id,console.log("[DEBUG] create result=",e.data)}await l(),r.value=!1,console.log("[DEBUG] submit finished, visible=",r.value)}catch(e){console.error("[ERROR] submit failed",e)}}function L(){console.log("[DEBUG] closeDialog called"),r.value=!1}return Q(l),$(()=>C.params.key,async t=>{t&&(v.value=t,console.log("[DEBUG] route key changed, newKey=",t),await l())}),(t,e)=>{const c=f("el-button"),D=f("el-table-column"),O=f("el-table"),j=f("el-skeleton"),z=f("el-dialog"),S=f("el-card");return s(),_(S,{class:"page-card"},{header:n(()=>[G("div",ae,[G("span",null,X(p.value.title),1),d(c,{type:"primary",onClick:k},{default:n(()=>[...e[3]||(e[3]=[x("新增",-1)])]),_:1})])]),default:n(()=>[G("div",le,[d(O,{data:u.value,border:"",style:{"min-height":"400px"}},{default:n(()=>[(s(!0),w(I,null,V(p.value.tableColumns,o=>(s(),_(D,{key:o.prop,prop:o.prop,label:o.label,width:o.width},null,8,["prop","label","width"]))),128)),d(D,{label:"图片"},{default:n(({row:o})=>[(s(!0),w(I,null,V(y(o),E=>(s(),w("img",{key:E.id??E.image,src:E.image,class:"preview-img"},null,8,oe))),128))]),_:1}),d(D,{width:"120"},{default:n(({row:o})=>[d(c,{size:"small",onClick:E=>A(o)},{default:n(()=>[...e[4]||(e[4]=[x("编辑",-1)])]),_:1},8,["onClick"]),d(c,{size:"small",type:"danger",onClick:E=>N(o)},{default:n(()=>[...e[5]||(e[5]=[x("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),h.value?W("",!0):(s(),_(j,{key:0,rows:5,animated:"",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(255, 255, 255, 0.8)"}}))]),d(z,{modelValue:r.value,"onUpdate:modelValue":e[2]||(e[2]=o=>r.value=o),width:"700px","before-close":L},{footer:n(()=>[d(c,{onClick:e[1]||(e[1]=o=>r.value=!1)},{default:n(()=>[...e[6]||(e[6]=[x("取消",-1)])]),_:1}),d(c,{type:"primary",onClick:T},{default:n(()=>[...e[7]||(e[7]=[x("保存",-1)])]),_:1})]),default:n(()=>[(s(),_(ee,{key:m.value,modelValue:a.value,"onUpdate:modelValue":e[0]||(e[0]=o=>a.value=o),config:p.value,"existing-images":i.value,onRemoveRemote:P},null,8,["modelValue","config","existing-images"]))]),_:1},8,["modelValue"])]),_:1})}}}),se=Y(ne,[["__scopeId","data-v-368afc1e"]]);export{se as default};
