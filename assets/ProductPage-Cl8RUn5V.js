import{r as u,S as v,R as G,Q as S,d as O,o as H,w as I,q as B,e as V,f as d,g as x,b as o,k as h,c as E,p as K,m as A,F as X,_ as Y,h as Z,u as ee,i as ae,W as $}from"./index-BH2z2_Ql.js";import{I as D}from"./ImageUpload-7eKuGYQY.js";import{a as le,u as te,c as oe}from"./product.service-C7645bNo.js";function ie(){const b=u([]),p=u(!1),U=u(!1),f=u(""),_=async()=>{p.value=!0;try{b.value=await S()}catch{v.error("获取分类失败")}finally{p.value=!1}};return{categories:b,loading:p,showAddCategory:U,newCategoryName:f,fetchCategories:_,addCategory:async i=>{if(!i.name.trim())return v.warning("分类名称不能为空"),null;try{const c=await G(i);return await _(),v.success("分类创建成功"),c}catch{return v.error("分类创建失败"),null}}}}const ne={class:"actions"},se=O({__name:"ProductForm",props:{initialData:{}},emits:["submit"],setup(b,{emit:p}){const U=b,f=p,{fetchCategories:_}=ie(),F=u([]),i=u({name:"",category_id:null,price:null,description:""}),c=u(null),m=u(null),g=u(!1),n=u([]),r=u([]),R=u([]),k=u([]);H(async()=>{F.value=await S()}),I(()=>U.initialData,async a=>{a&&(await _(),Object.assign(i.value,a.form),m.value=a.coverUrl||null,c.value=null,g.value=!1,r.value=a.detailImageUrls||[],k.value=(a.variants||[]).map(e=>({id:e.id,uid:e.uid??`${e.id}-${Date.now()}`,style_name:e.style_name,spec:e.spec,stock:Number(e.stock)||0,imageFiles:[],imageUrl:e.imageUrl??null})))},{immediate:!0});function L(){c.value=null,m.value=null,g.value=!0}I(c,a=>{a&&(g.value=!1)});function j(a){r.value=r.value.filter(e=>e!==a),R.value.push(a)}function M(a,e){e===null?a.imageFiles=[]:Array.isArray(e)?a.imageFiles=[...e]:a.imageFiles=[e],a.imageFiles.length>0&&a.imageUrl&&(a.imageUrl=null)}function T(a){a.imageUrl=null,a.imageFiles=[]}function J(){k.value.push({uid:`${Date.now()}-${Math.random()}`,style_name:"",spec:"",stock:0,imageFiles:[],imageUrl:null})}function q(a){k.value.splice(a,1)}async function Q(){if(!i.value.name||!i.value.category_id){v.warning("请填写完整信息");return}const a=new FormData;Object.entries(i.value).forEach(([s,l])=>{l!==null&&l!==""&&a.append(s,String(l))}),c.value?a.append("cover",c.value):g.value&&a.append("cover",""),n.value.forEach(s=>a.append("uploaded_images",s));const e=k.value.filter(s=>s.style_name?.trim());if(e.length){const s=e.map(l=>({id:l.id,uid:l.uid,style_name:l.style_name,spec:l.spec??"",stock:Number(l.stock)||0,hasImage:l.imageFiles?.length>0,imageUrl:l.imageUrl,remove_image:!l.imageUrl&&l.imageFiles.length===0}));a.append("uploaded_variants",JSON.stringify(s)),e.forEach(l=>{const C=l.imageFiles?.[0];if(C){const w=l.uid;a.append(`uploaded_variants_images_${w}`,C)}})}R.value.length&&a.append("removed_detail_images",JSON.stringify(R.value)),f("submit",a),e.forEach(s=>{const l=s.imageFiles?.[0];l&&!s.imageUrl&&(s.imageUrl=URL.createObjectURL(l),s.imageFiles=[])})}return(a,e)=>{const s=V("el-input"),l=V("el-form-item"),C=V("el-cascader"),w=V("el-input-number"),N=V("el-card"),P=V("el-button"),W=V("el-form");return x(),B(W,{"label-position":"top",class:"product-form"},{default:d(()=>[o(N,{class:"glass-card"},{default:d(()=>[e[6]||(e[6]=h("h3",null,"基础信息",-1)),o(l,{label:"产品名称"},{default:d(()=>[o(s,{modelValue:i.value.name,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value.name=t)},null,8,["modelValue"])]),_:1}),o(l,{label:"产品分类"},{default:d(()=>[o(C,{modelValue:i.value.category_id,"onUpdate:modelValue":e[1]||(e[1]=t=>i.value.category_id=t),options:F.value,props:{value:"id",label:"name",children:"children",emitPath:!1}},null,8,["modelValue","options"])]),_:1}),o(l,{label:"价格"},{default:d(()=>[o(w,{modelValue:i.value.price,"onUpdate:modelValue":e[2]||(e[2]=t=>i.value.price=t),min:0},null,8,["modelValue"])]),_:1}),o(l,{label:"描述"},{default:d(()=>[o(s,{type:"textarea",modelValue:i.value.description,"onUpdate:modelValue":e[3]||(e[3]=t=>i.value.description=t)},null,8,["modelValue"])]),_:1})]),_:1}),o(N,{class:"glass-card"},{default:d(()=>[e[7]||(e[7]=h("h3",null,"图片",-1)),o(l,{label:"主图"},{default:d(()=>[o(D,{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=t=>c.value=t),"existing-images":m.value?[m.value]:[],onRemoveRemote:L},null,8,["modelValue","existing-images"])]),_:1}),o(l,{label:"详情图"},{default:d(()=>[o(D,{modelValue:n.value,"onUpdate:modelValue":e[5]||(e[5]=t=>n.value=t),multiple:"","existing-images":r.value,onRemoveRemote:j},null,8,["modelValue","existing-images"])]),_:1})]),_:1}),o(N,{class:"glass-card"},{default:d(()=>[e[10]||(e[10]=h("h3",null,"产品款式",-1)),(x(!0),E(X,null,K(k.value,(t,z)=>(x(),E("div",{key:t.uid,class:"variant-row"},[o(s,{modelValue:t.style_name,"onUpdate:modelValue":y=>t.style_name=y,placeholder:"款式名称"},null,8,["modelValue","onUpdate:modelValue"]),o(s,{modelValue:t.spec,"onUpdate:modelValue":y=>t.spec=y,placeholder:"规格"},null,8,["modelValue","onUpdate:modelValue"]),o(w,{modelValue:t.stock,"onUpdate:modelValue":y=>t.stock=y,min:0},null,8,["modelValue","onUpdate:modelValue"]),o(D,{"model-value":t.imageFiles,"existing-images":t.imageUrl?[t.imageUrl]:[],"onUpdate:modelValue":y=>M(t,y),onRemoveRemote:()=>T(t)},null,8,["model-value","existing-images","onUpdate:modelValue","onRemoveRemote"]),o(P,{type:"danger",text:"",onClick:y=>q(z)},{default:d(()=>[...e[8]||(e[8]=[A(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128)),o(P,{onClick:J},{default:d(()=>[...e[9]||(e[9]=[A("+ 添加款式",-1)])]),_:1})]),_:1}),h("div",ne,[o(P,{type:"primary",onClick:Q},{default:d(()=>[...e[11]||(e[11]=[A("保存",-1)])]),_:1})])]),_:1})}}}),re=Y(se,[["__scopeId","data-v-86bf02cf"]]),ce=O({__name:"ProductPage",setup(b){const p=ee(),U=ae(),f=u(!1),_=u(null),F=()=>!!p.params.id;async function i(m){const g=$.service({text:"加载中..."});f.value=!1;try{const n=await le(m);_.value={form:{name:n.name,category_id:n.category?.id??null,price:Number(n.price??0),description:n.description??"",is_active:n.is_active??!0,is_featured:n.is_featured??!1},coverUrl:n.cover??null,detailImageUrls:Array.isArray(n.detail_images)?n.detail_images.map(r=>r.image):[],variants:Array.isArray(n.variants)?n.variants.map(r=>({id:r.id,uid:r.id,style_name:r.style_name,spec:r.spec,stock:Number(r.stock??0),imageUrl:typeof r.style_image=="string"&&r.style_image.length>0?r.style_image:null})):[]}}finally{f.value=!0,g.close()}}I(()=>p.params.id,m=>{if(!m){_.value=null,f.value=!0;return}i(Number(m))},{immediate:!0});async function c(m){const g=$.service({text:"保存中..."});try{F()?(await te(Number(p.params.id),m),v.success("保存成功"),U.push("/admin/products")):(await oe(m),v.success("创建成功"),U.push("/admin/products"))}catch(n){v.error("保存失败"),console.error("保存错误:",n)}finally{g.close()}}return(m,g)=>f.value?(x(),B(re,{key:0,"initial-data":_.value,onSubmit:c},null,8,["initial-data"])):Z("",!0)}});export{ce as default};
