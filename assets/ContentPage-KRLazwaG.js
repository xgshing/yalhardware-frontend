import{d as F,G as q,w as $,q as E,g as i,e as f,f as r,c as U,p as I,Y as M,Z as Y,F as V,$ as w,r as v,u as Z,j as H,o as J,k as G,b as d,h as K,m as x,t as Q,A as R,_ as W}from"./index-CmjdxzPn.js";import{I as X}from"./ImageUpload-k5dVJQyf.js";const ee=F({__name:"ContentForm",props:{modelValue:{},config:{},existingImages:{}},emits:["update:modelValue","remove-remote"],setup(B,{emit:C}){const b=B,u=C,p=q({...b.modelValue});$(()=>p,l=>{u("update:modelValue",l),console.log("[DEBUG][ContentForm] internalValue updated",l)},{deep:!0});function h(l){switch(l){case"input":return"el-input";case"textarea":return"el-input";case"number":return"el-input-number";case"switch":return"el-switch";case"image":return X;default:return"el-input"}}function s(l){if(l.type==="textarea")return{type:"textarea",placeholder:l.label};if(l.type==="image"){const a=(b.existingImages??[]).map(c=>c.image_url);return console.log("[DEBUG][ContentForm] existingImages passed to ImageUpload",a),{multiple:l.multiple??!1,existingImages:a,"onRemove-remote":c=>{const g=(b.existingImages??[]).find(o=>o.image_url===c);g&&(console.log("[DEBUG][ContentForm] remove-remote emitted",g.id),u("remove-remote",g.id))}}}return l.type==="number"?{min:0,placeholder:l.label}:{placeholder:l.label}}function _(l){l.type==="switch"&&(p[l.prop]=!!p[l.prop],console.log(`[DEBUG][ContentForm] switch ${l.prop} changed to`,p[l.prop]))}return(l,a)=>{const c=f("el-form-item"),g=f("el-form");return i(),E(g,{"label-position":"top"},{default:r(()=>[(i(!0),U(V,null,I(B.config?.formFields||[],o=>(i(),E(c,{key:o.prop,label:o.label},{default:r(()=>[(i(),E(M(h(o.type)),Y({modelValue:p[o.prop],"onUpdate:modelValue":D=>p[o.prop]=D},{ref_for:!0},s(o),{onChange:D=>_(o)}),null,16,["modelValue","onUpdate:modelValue","onChange"]))]),_:2},1032,["label"]))),128))]),_:1})}}}),te={banners:{title:"首页轮播",api:w.banners,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"轮播图片",type:"image",multiple:!0},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]},features:{title:"首页特色",api:w.features,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"图标",type:"image",multiple:!1},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]},stories:{title:"品牌故事",api:w.stories,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"图片",type:"image",multiple:!0},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]}},le={class:"card-header"},ae={class:"table-wrapper",style:{position:"relative"}},oe=["src"],ne=F({__name:"ContentPage",setup(B){const C=Z(),b=v(C.params.key),u=H(()=>{const e=te[b.value];if(!e)throw new Error(`Invalid content key: ${b.value}`);return e}),p=v([]),h=v(!0),s=v(!1),_=v(null),l=v({}),a=v([]),c=v(0);function g(e){return e.images?e.images:e.icon?Array.isArray(e.icon)?e.icon:[{image_url:e.icon}]:[]}async function o(){h.value=!1;try{const e=await u.value.api.list();p.value=e.data||[],console.log("[DEBUG] fetchList",p.value)}finally{h.value=!0}}function D(){console.log("[DEBUG] openCreate called"),_.value=null,l.value={},a.value=[],c.value++,s.value=!0,R(()=>console.log("[DEBUG] openCreate nextTick, visible=",s.value))}function A(e){console.log("[DEBUG] openEdit called, row=",e),_.value=e.id,l.value={...e},console.log("[DEBUG] openEdit called, row=",e),console.log("[DEBUG] existingImages before mapping=",e.images||e.icon),a.value=g(e).map(t=>({id:t.id,image_url:t.image_url})),c.value++,console.log("[DEBUG] openEdit existingImages=",a.value),s.value=!0,R(()=>console.log("[DEBUG] openEdit nextTick, visible=",s.value))}async function N(e){console.log("[DEBUG] deleteRow called, row=",e);try{await u.value.api.delete(e.id),await o()}catch(t){console.error("[ERROR] deleteRow failed",t)}}function P(e){console.log("[DEBUG] removeRemoteImage called, id=",e),console.log("[DEBUG] existingImages before removal=",a.value),a.value=a.value.filter(t=>t.id!==e),console.log("[DEBUG] existingImages after removal=",a.value)}async function T(){console.log("[DEBUG] submit called, form=",l.value,"existingImages=",a.value);const e=new FormData;Object.entries(l.value).forEach(([t,m])=>{t!=="images"&&e.append(t,m)}),a.value.forEach(t=>e.append("existing_images",String(t.id))),console.log("[DEBUG] FormData entries:");for(const t of e.entries())console.log(t[0],t[1]);l.value.images&&(Array.isArray(l.value.images)?l.value.images:[l.value.images]).forEach(m=>e.append("images",m));try{if(_.value)await u.value.api.update(_.value,e);else{const t=await u.value.api.create(e);_.value=t.data.id,console.log("[DEBUG] create result=",t.data)}await o(),s.value=!1,console.log("[DEBUG] submit finished, visible=",s.value)}catch(t){console.error("[ERROR] submit failed",t)}}function L(){console.log("[DEBUG] closeDialog called"),s.value=!1}return J(o),$(()=>C.params.key,async e=>{e&&(b.value=e,console.log("[DEBUG] route key changed, newKey=",e),await o())}),(e,t)=>{const m=f("el-button"),k=f("el-table-column"),O=f("el-table"),j=f("el-skeleton"),z=f("el-dialog"),S=f("el-card");return i(),E(S,{class:"page-card"},{header:r(()=>[G("div",le,[G("span",null,Q(u.value.title),1),d(m,{type:"primary",onClick:D},{default:r(()=>[...t[3]||(t[3]=[x("新增",-1)])]),_:1})])]),default:r(()=>[G("div",ae,[d(O,{data:p.value,border:"",style:{"min-height":"400px"}},{default:r(()=>[(i(!0),U(V,null,I(u.value.tableColumns,n=>(i(),E(k,{key:n.prop,prop:n.prop,label:n.label,width:n.width},null,8,["prop","label","width"]))),128)),d(k,{label:"图片"},{default:r(({row:n})=>[(i(!0),U(V,null,I(g(n),y=>(i(),U("img",{key:y.id||y.image_url||y,src:y.image_url||y,class:"preview-img"},null,8,oe))),128))]),_:1}),d(k,{width:"120"},{default:r(({row:n})=>[d(m,{size:"small",onClick:y=>A(n)},{default:r(()=>[...t[4]||(t[4]=[x("编辑",-1)])]),_:1},8,["onClick"]),d(m,{size:"small",type:"danger",onClick:y=>N(n)},{default:r(()=>[...t[5]||(t[5]=[x("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),h.value?K("",!0):(i(),E(j,{key:0,rows:5,animated:"",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(255, 255, 255, 0.8)"}}))]),d(z,{modelValue:s.value,"onUpdate:modelValue":t[2]||(t[2]=n=>s.value=n),width:"700px","before-close":L},{footer:r(()=>[d(m,{onClick:t[1]||(t[1]=n=>s.value=!1)},{default:r(()=>[...t[6]||(t[6]=[x("取消",-1)])]),_:1}),d(m,{type:"primary",onClick:T},{default:r(()=>[...t[7]||(t[7]=[x("保存",-1)])]),_:1})]),default:r(()=>[(i(),E(ee,{key:c.value,modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=n=>l.value=n),config:u.value,"existing-images":a.value,onRemoveRemote:P},null,8,["modelValue","config","existing-images"]))]),_:1},8,["modelValue"])]),_:1})}}}),ie=W(ne,[["__scopeId","data-v-37d937c0"]]);export{ie as default};
