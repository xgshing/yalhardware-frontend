import{Y as O,r as u,S as v,d as B,o as H,w as I,q as L,e as V,f as d,g as x,b as o,k as h,c as E,p as K,m as P,F as Q,_ as W,h as X,u as ee,i as ae,Z as $,$ as le,a0 as te,a1 as oe}from"./index-DzFIMJFo.js";import{I as D}from"./ImageUpload-BmP8T7Bl.js";import{f as ne}from"./category.service.admin-CJbGKSRh.js";const se=async()=>(await O.get("/categories/")).data,ie=async g=>(await O.post("/categories/",g)).data,S={getCategories:se,createCategory:ie};function re(){const g=u([]),p=u(!1),U=u(!1),_=u("");return{categories:g,loading:p,showAddCategory:U,newCategoryName:_,fetchCategories:async()=>{p.value=!0;try{const n=await S.getCategories();g.value=n}catch{v.error("获取分类失败")}finally{p.value=!1}},createCategory:async n=>{if(!n.name.trim())return v.warning("分类名称不能为空"),null;try{const c=await S.createCategory(n);return g.value.push(c),v.success("分类创建成功"),c}catch{return v.error("分类创建失败"),null}}}}const ue={class:"actions"},me=B({__name:"ProductForm",props:{initialData:{}},emits:["submit"],setup(g,{emit:p}){const U=g,_=p,{fetchCategories:b}=re(),C=u([]),n=u({name:"",category_id:null,price:null,description:""}),c=u(null),m=u(null),f=u(!1),s=u([]),r=u([]),R=u([]),F=u([]);H(async()=>{C.value=await ne()}),I(()=>U.initialData,async a=>{a&&(await b(),Object.assign(n.value,a.form),m.value=a.coverUrl||null,c.value=null,f.value=!1,r.value=a.detailImageUrls||[],F.value=(a.variants||[]).map(e=>({id:e.id,uid:e.uid??`${e.id}-${Date.now()}`,style_name:e.style_name,spec:e.spec,stock:Number(e.stock)||0,imageFiles:[],imageUrl:e.imageUrl??null})))},{immediate:!0});function j(){c.value=null,m.value=null,f.value=!0}I(c,a=>{a&&(f.value=!1)});function M(a){r.value=r.value.filter(e=>e!==a),R.value.push(a)}function T(a,e){e===null?a.imageFiles=[]:Array.isArray(e)?a.imageFiles=[...e]:a.imageFiles=[e],a.imageFiles.length>0&&a.imageUrl&&(a.imageUrl=null)}function q(a){a.imageUrl=null,a.imageFiles=[]}function J(){F.value.push({uid:`${Date.now()}-${Math.random()}`,style_name:"",spec:"",stock:0,imageFiles:[],imageUrl:null})}function Y(a){F.value.splice(a,1)}async function Z(){if(!n.value.name||!n.value.category_id){v.warning("请填写完整信息");return}const a=new FormData;Object.entries(n.value).forEach(([i,l])=>{l!==null&&l!==""&&a.append(i,String(l))}),c.value?a.append("cover",c.value):f.value&&a.append("cover",""),s.value.forEach(i=>a.append("uploaded_images",i));const e=F.value.filter(i=>i.style_name?.trim());if(e.length){const i=e.map(l=>({id:l.id,uid:l.uid,style_name:l.style_name,spec:l.spec??"",stock:Number(l.stock)||0,hasImage:l.imageFiles?.length>0,imageUrl:l.imageUrl,remove_image:!l.imageUrl&&l.imageFiles.length===0}));a.append("uploaded_variants",JSON.stringify(i)),e.forEach(l=>{const k=l.imageFiles?.[0];if(k){const w=l.uid;a.append(`uploaded_variants_images_${w}`,k)}})}R.value.length&&a.append("removed_detail_images",JSON.stringify(R.value)),_("submit",a),e.forEach(i=>{const l=i.imageFiles?.[0];l&&!i.imageUrl&&(i.imageUrl=URL.createObjectURL(l),i.imageFiles=[])})}return(a,e)=>{const i=V("el-input"),l=V("el-form-item"),k=V("el-cascader"),w=V("el-input-number"),N=V("el-card"),A=V("el-button"),z=V("el-form");return x(),L(z,{"label-position":"top",class:"product-form"},{default:d(()=>[o(N,{class:"glass-card"},{default:d(()=>[e[6]||(e[6]=h("h3",null,"基础信息",-1)),o(l,{label:"产品名称"},{default:d(()=>[o(i,{modelValue:n.value.name,"onUpdate:modelValue":e[0]||(e[0]=t=>n.value.name=t)},null,8,["modelValue"])]),_:1}),o(l,{label:"产品分类"},{default:d(()=>[o(k,{modelValue:n.value.category_id,"onUpdate:modelValue":e[1]||(e[1]=t=>n.value.category_id=t),options:C.value,props:{value:"id",label:"name",children:"children",emitPath:!1}},null,8,["modelValue","options"])]),_:1}),o(l,{label:"价格"},{default:d(()=>[o(w,{modelValue:n.value.price,"onUpdate:modelValue":e[2]||(e[2]=t=>n.value.price=t),min:0},null,8,["modelValue"])]),_:1}),o(l,{label:"描述"},{default:d(()=>[o(i,{type:"textarea",modelValue:n.value.description,"onUpdate:modelValue":e[3]||(e[3]=t=>n.value.description=t)},null,8,["modelValue"])]),_:1})]),_:1}),o(N,{class:"glass-card"},{default:d(()=>[e[7]||(e[7]=h("h3",null,"图片",-1)),o(l,{label:"主图"},{default:d(()=>[o(D,{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=t=>c.value=t),"existing-images":m.value?[m.value]:[],onRemoveRemote:j},null,8,["modelValue","existing-images"])]),_:1}),o(l,{label:"详情图"},{default:d(()=>[o(D,{modelValue:s.value,"onUpdate:modelValue":e[5]||(e[5]=t=>s.value=t),multiple:"","existing-images":r.value,onRemoveRemote:M},null,8,["modelValue","existing-images"])]),_:1})]),_:1}),o(N,{class:"glass-card"},{default:d(()=>[e[10]||(e[10]=h("h3",null,"产品款式",-1)),(x(!0),E(Q,null,K(F.value,(t,G)=>(x(),E("div",{key:t.uid,class:"variant-row"},[o(i,{modelValue:t.style_name,"onUpdate:modelValue":y=>t.style_name=y,placeholder:"款式名称"},null,8,["modelValue","onUpdate:modelValue"]),o(i,{modelValue:t.spec,"onUpdate:modelValue":y=>t.spec=y,placeholder:"规格"},null,8,["modelValue","onUpdate:modelValue"]),o(w,{modelValue:t.stock,"onUpdate:modelValue":y=>t.stock=y,min:0},null,8,["modelValue","onUpdate:modelValue"]),o(D,{"model-value":t.imageFiles,"existing-images":t.imageUrl?[t.imageUrl]:[],"onUpdate:modelValue":y=>T(t,y),onRemoveRemote:()=>q(t)},null,8,["model-value","existing-images","onUpdate:modelValue","onRemoveRemote"]),o(A,{type:"danger",text:"",onClick:y=>Y(G)},{default:d(()=>[...e[8]||(e[8]=[P(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128)),o(A,{onClick:J},{default:d(()=>[...e[9]||(e[9]=[P("+ 添加款式",-1)])]),_:1})]),_:1}),h("div",ue,[o(A,{type:"primary",onClick:Z},{default:d(()=>[...e[11]||(e[11]=[P("保存",-1)])]),_:1})])]),_:1})}}}),de=W(me,[["__scopeId","data-v-0d3311bc"]]),fe=B({__name:"ProductPage",setup(g){const p=ee(),U=ae(),_=u(!1),b=u(null),C=()=>!!p.params.id;async function n(m){const f=$.service({text:"加载中..."});_.value=!1;try{const s=await le(m);b.value={form:{name:s.name,category_id:s.category?.id??null,price:Number(s.price??0),description:s.description??"",is_active:s.is_active??!0,is_featured:s.is_featured??!1},coverUrl:s.cover??null,detailImageUrls:Array.isArray(s.detail_images)?s.detail_images.map(r=>r.image):[],variants:Array.isArray(s.variants)?s.variants.map(r=>({id:r.id,uid:r.id,style_name:r.style_name,spec:r.spec,stock:Number(r.stock??0),imageUrl:typeof r.style_image=="string"&&r.style_image.length>0?r.style_image:null})):[]}}finally{_.value=!0,f.close()}}I(()=>p.params.id,m=>{if(!m){b.value=null,_.value=!0;return}n(Number(m))},{immediate:!0});async function c(m){const f=$.service({text:"保存中..."});try{C()?(await te(Number(p.params.id),m),v.success("保存成功"),U.push("/admin/products")):(await oe(m),v.success("创建成功"),U.push("/admin/products"))}catch(s){v.error("保存失败"),console.error("保存错误:",s)}finally{f.close()}}return(m,f)=>_.value?(x(),L(de,{key:0,"initial-data":b.value,onSubmit:c},null,8,["initial-data"])):X("",!0)}});export{fe as default};
