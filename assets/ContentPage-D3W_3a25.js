import{d as A,G as Y,w as P,q as x,g as m,e as y,f as r,c as k,p as V,a2 as H,a3 as J,F as R,Y as u,r as v,u as K,o as Q,k as G,b,h as W,m as U,t as X,A as F,_ as Z}from"./index-DSKL3z2g.js";import{I as ee}from"./ImageUpload-BFS9ahwq.js";const te=A({__name:"ContentForm",props:{modelValue:{},config:{},existingImages:{}},emits:["update:modelValue","remove-remote"],setup(l,{emit:c}){const h=l,p=c,d=Y({...h.modelValue});P(()=>d,a=>{p("update:modelValue",a),console.log("[DEBUG][ContentForm] internalValue updated",a)},{deep:!0});function D(a){switch(a){case"input":return"el-input";case"textarea":return"el-input";case"number":return"el-input-number";case"switch":return"el-switch";case"image":return ee;default:return"el-input"}}function i(a){if(a.type==="textarea")return{type:"textarea",placeholder:a.label};if(a.type==="image"){const o=(h.existingImages??[]).map(g=>g.image_url);return console.log("[DEBUG][ContentForm] existingImages passed to ImageUpload",o),{multiple:a.multiple??!1,existingImages:o,"onRemove-remote":g=>{const _=(h.existingImages??[]).find(n=>n.image_url===g);_&&(console.log("[DEBUG][ContentForm] remove-remote emitted",_.id),p("remove-remote",_.id))}}}return a.type==="number"?{min:0,placeholder:a.label}:{placeholder:a.label}}function E(a){a.type==="switch"&&(d[a.prop]=!!d[a.prop],console.log(`[DEBUG][ContentForm] switch ${a.prop} changed to`,d[a.prop]))}return(a,o)=>{const g=y("el-form-item"),_=y("el-form");return m(),x(_,{"label-position":"top"},{default:r(()=>[(m(!0),k(R,null,V(l.config?.formFields||[],n=>(m(),x(g,{key:n.prop,label:n.label},{default:r(()=>[(m(),x(H(D(n.type)),J({modelValue:d[n.prop],"onUpdate:modelValue":B=>d[n.prop]=B},{ref_for:!0},i(n),{onChange:B=>E(n)}),null,16,["modelValue","onUpdate:modelValue","onChange"]))]),_:2},1032,["label"]))),128))]),_:1})}}}),I={banner:{list:()=>u.get("/admin/home/banners/"),create:l=>u.post("/admin/home/banners/",l),update:(l,c)=>u.put(`/admin/home/banners/${l}/`,c),delete:l=>u.delete(`/admin/home/banners/${l}/`)},feature:{list:()=>u.get("/admin/home/features/"),create:l=>u.post("/admin/home/features/",l),update:(l,c)=>u.put(`/admin/home/features/${l}/`,c),delete:l=>u.delete(`/admin/home/features/${l}/`)},story:{list:()=>u.get("/admin/home/stories/"),create:l=>u.post("/admin/home/stories/",l),update:(l,c)=>u.put(`/admin/home/stories/${l}/`,c),delete:l=>u.delete(`/admin/home/stories/${l}/`)}},$={banners:{title:"首页轮播",api:I.banner,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"轮播图片",type:"image",multiple:!0},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]},features:{title:"首页特色",api:I.feature,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"图标",type:"image",multiple:!1},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]},stories:{title:"品牌故事",api:I.story,tableColumns:[{prop:"order",label:"排序",width:80},{prop:"title",label:"标题"}],formFields:[{prop:"title",label:"标题",type:"input"},{prop:"description",label:"描述",type:"textarea"},{prop:"images",label:"图片",type:"image",multiple:!0},{prop:"order",label:"排序",type:"number"},{prop:"is_active",label:"启用",type:"switch"}]}},ae={class:"card-header"},le={class:"table-wrapper",style:{position:"relative"}},oe=["src"],ne=A({__name:"ContentPage",setup(l){const c=K(),h=v(c.params.key),p=v($[h.value]),d=v([]),D=v(!0),i=v(!1),E=v(null),a=v({}),o=v([]),g=v(0);function _(t){return t.images?t.images:t.icon?Array.isArray(t.icon)?t.icon:[{image_url:t.icon}]:[]}async function n(){D.value=!1;try{const t=await p.value.api.list();d.value=t.data||[],console.log("[DEBUG] fetchList",d.value)}finally{D.value=!0}}function B(){console.log("[DEBUG] openCreate called"),E.value=null,a.value={},o.value=[],g.value++,i.value=!0,F(()=>console.log("[DEBUG] openCreate nextTick, visible=",i.value))}function N(t){console.log("[DEBUG] openEdit called, row=",t),E.value=t.id,a.value={...t},console.log("[DEBUG] openEdit called, row=",t),console.log("[DEBUG] existingImages before mapping=",t.images||t.icon),o.value=_(t).map(e=>({id:e.id,image_url:e.image_url})),g.value++,console.log("[DEBUG] openEdit existingImages=",o.value),i.value=!0,F(()=>console.log("[DEBUG] openEdit nextTick, visible=",i.value))}async function T(t){console.log("[DEBUG] deleteRow called, row=",t);try{await p.value.api.delete(t.id),await n()}catch(e){console.error("[ERROR] deleteRow failed",e)}}function L(t){console.log("[DEBUG] removeRemoteImage called, id=",t),console.log("[DEBUG] existingImages before removal=",o.value),o.value=o.value.filter(e=>e.id!==t),console.log("[DEBUG] existingImages after removal=",o.value)}async function O(){console.log("[DEBUG] submit called, form=",a.value,"existingImages=",o.value);const t=new FormData;Object.entries(a.value).forEach(([e,f])=>{e!=="images"&&t.append(e,f)}),o.value.forEach(e=>t.append("existing_images",String(e.id))),console.log("[DEBUG] FormData entries:");for(const e of t.entries())console.log(e[0],e[1]);a.value.images&&(Array.isArray(a.value.images)?a.value.images:[a.value.images]).forEach(f=>t.append("images",f));try{if(E.value)await p.value.api.update(E.value,t);else{const e=await p.value.api.create(t);E.value=e.data.id,console.log("[DEBUG] create result=",e.data)}await n(),i.value=!1,console.log("[DEBUG] submit finished, visible=",i.value)}catch(e){console.error("[ERROR] submit failed",e)}}function q(){console.log("[DEBUG] closeDialog called"),i.value=!1}return Q(n),P(()=>c.params.key,async t=>{t&&(h.value=t,p.value=$[h.value],console.log("[DEBUG] route key changed, newKey=",t),await n())}),(t,e)=>{const f=y("el-button"),w=y("el-table-column"),z=y("el-table"),S=y("el-skeleton"),j=y("el-dialog"),M=y("el-card");return m(),x(M,{class:"page-card"},{header:r(()=>[G("div",ae,[G("span",null,X(p.value.title),1),b(f,{type:"primary",onClick:B},{default:r(()=>[...e[3]||(e[3]=[U("新增",-1)])]),_:1})])]),default:r(()=>[G("div",le,[b(z,{data:d.value,border:"",style:{"min-height":"400px"}},{default:r(()=>[(m(!0),k(R,null,V(p.value.tableColumns,s=>(m(),x(w,{key:s.prop,prop:s.prop,label:s.label,width:s.width},null,8,["prop","label","width"]))),128)),b(w,{label:"图片"},{default:r(({row:s})=>[(m(!0),k(R,null,V(_(s),C=>(m(),k("img",{key:C.id||C.image_url||C,src:C.image_url||C,class:"preview-img"},null,8,oe))),128))]),_:1}),b(w,{width:"120"},{default:r(({row:s})=>[b(f,{size:"small",onClick:C=>N(s)},{default:r(()=>[...e[4]||(e[4]=[U("编辑",-1)])]),_:1},8,["onClick"]),b(f,{size:"small",type:"danger",onClick:C=>T(s)},{default:r(()=>[...e[5]||(e[5]=[U("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),D.value?W("",!0):(m(),x(S,{key:0,rows:5,animated:"",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(255, 255, 255, 0.8)"}}))]),b(j,{modelValue:i.value,"onUpdate:modelValue":e[2]||(e[2]=s=>i.value=s),width:"700px","before-close":q},{footer:r(()=>[b(f,{onClick:e[1]||(e[1]=s=>i.value=!1)},{default:r(()=>[...e[6]||(e[6]=[U("取消",-1)])]),_:1}),b(f,{type:"primary",onClick:O},{default:r(()=>[...e[7]||(e[7]=[U("保存",-1)])]),_:1})]),default:r(()=>[(m(),x(te,{key:g.value,modelValue:a.value,"onUpdate:modelValue":e[0]||(e[0]=s=>a.value=s),config:p.value,"existing-images":o.value,onRemoveRemote:L},null,8,["modelValue","config","existing-images"]))]),_:1},8,["modelValue"])]),_:1})}}}),ie=Z(ne,[["__scopeId","data-v-3489a830"]]);export{ie as default};
